function trackplot(dt,lat,lon, LON, LAT),%=============================================% function trackplot(dt,lat,lon, LON, LAT),%%INPUT% dt = datenum series% lat = latitude series% lon = longitude series% Optinal input:%  LON 2x1 = lonmin, lonmax%  LAT 2x1 = latmin, latmax%%needs "addpath('/Users/rmr/swmain/matlab/crusty/m_map')"%110808 v2 rmr -- fool around with a gap. 2*ddp/60 minutes%=============================================global STARTTIME ENDTIMEdisp('trackplot');addpath('/Users/rmr/swmain/matlab/crusty/m_map')%% GET THE DATA AND SETUP PATHES% If the number of days is less than this number only the start and stop % times will be given.nlabels = 8;% CRUSTY = FindInfo(SETUPFILE,'CRUSTY');% mp = fullfile(CRUSTY,'m_map');% path(path,mp);% % READ THE DA0 LEVEL1 MAT FILE FOR POSITION DATA% LEVEL1_PATH = FindInfo(SETUPFILE,'PRP LEVEL 1 PATH');% fn = fullfile(LEVEL1_PATH, 'nav.mat');% cmd = sprintf('load %s',fn);% fprintf('%s\n', cmd);% eval(cmd);%PUT LON IN THE RANGE -180 TO 180lon = CompassCheck(lon);%if max(ScrubSeries(lon)) - min(ScrubSeries(lon)) > 180,%    ix = find(lon > 180);%    if length(ix) > 0%        lon(ix) = lon(ix) -360;%    end%end%if max(ScrubSeries(lon)) - min(ScrubSeries(lon)) > 180,%    ix = find(lon > 180);%    if length(ix) > 0%        lon(ix) = lon(ix) -360;%    end%end% FIND THE PERIOD OF THE SERIESdd = diff(dt)*86400;ddp = round(median(dd));fprintf('PERIOD = %.1f\n', ddp);% FILL THE TIME SERIES, FILL GAPS WITH NANS% v2 gap = 2*ddp secs[dtf,latf] = FillTimeSeries1sec_interp(dt,lat,2*ddp,STARTTIME,ENDTIME);[dtx,lonf] = FillTimeSeries1sec_interp(dt,lon,2*ddp,STARTTIME,ENDTIME);%% GRAPH delx = 0.1;  % jd offset in map plot, in degrees offset lat and lon%dtstart = DTSTART;    dtend = DTEND;dtstart = dt(1);  dtend = dt(end);% NUMBER OF DAYS TO SKIP BETWEEN DAY LABELSndaylabmax = 2;nskip = max(1, fix((dtend - dtstart)/ndaylabmax)+1);nskip=2;%% %%%%%%%%%%%%%% % PLOT THE MAP% %%%%%%%%%%%%%if nargin == 5,    lonmin = LON(1);    lonmax = LON(2);    latmin = LAT(1);    latmax = LAT(2);else    latmin = min(ScrubSeries(latf));    latmax = max(ScrubSeries(latf));    lonmin = min(ScrubSeries(lonf));    lonmax = max(ScrubSeries(lonf));    D = (latmax-latmin);    if D > 20,        scle = 5;    elseif D > 10,        scle = 2;    elseif D > 4,        scle = 1;    elseif D > 1,        scle = .5;    else        scle = .2;    end    if latmin >= 0, latmin = latmin - rem(latmin,scle); else latmin = latmin - scle - rem(latmin,scle); end    if latmax > 0, latmax = latmax + scle - rem(latmax,scle); else latmax = latmax - rem(latmax,scle); end    D = (lonmax-lonmin);    if D > 20,        scle = 5;    elseif D > 10,        scle = 2;    elseif D > 4,        scle = 1;    elseif D > 1,        scle = .5;    else        scle = .2;    end    if lonmin >= 0, lonmin = lonmin - rem(lonmin,scle); else lonmin = lonmin - scle - rem(lonmin,scle); end    if lonmax > 0, lonmax = lonmax + scle - rem(lonmax,scle); else lonmax = lonmax - rem(lonmax,scle); endendfprintf('LAT LIMS= [%.5f, %.5f], LONG LIMS = [%.5f, %.5f]\n',latmin,latmax,lonmin,lonmax);dely = 0.01 * (latmax - latmin );delx = 0.01 * ( lonmax - lonmin);disp('PLOT COASTLINES');figure('position',[10,100,700,700]);% projectionm_proj('mercator','longitudes',[lonmin, lonmax],'latitudes',[latmin, latmax]);%Ioffem_proj('mercator','longitudes',[-80, 10],'latitudes',[latmin, latmax]);% draw the coast linem_coast('patch',[.8 .8 .8]);%m_gshhs_h('patch',[.8 .8 .8]);% gridm_grid('fontname','helvetica','fontsize',12,'box','fancy',...	'linewidth',.5, 'linespec','-');set(gcf,'color','w');%==================% PLOT THE TRACK LINE%==================disp('plot track');% DIVIDE THE TRACK INTO SECTIONS BETWEEN NANSinan = union ( find(isnan(latf)), find(isnan(lonf)) );while length(inan) > 0 & inan(1) == 1,    latf(1)=[];  lonf(1)=[]; dtf(1)=[];    inan = union ( find(isnan(latf)), find(isnan(lonf)) );endfprintf('inan = %d\n',inan);%% UNBROKEN CRUISE TRACKif length(inan) == 0,	disp('unbroken');	m_track(lon,lat);		% START POINT	tx = m_text(lon(1),lat(1),'o','fontweight','bold','fontsize',14);	set(tx,'verticalalignment','middle','horizontalalignment','center','Color','r');	txstart = m_text(lon(1)-delx, lat(1)-delx, 'START', 'fontweight','normal','fontsize',14, 'color','red');	set(txstart,'verticalalignment','top','horizontalalignment','right');		% all jdays    	% ALL JDAYS IN THIS SEGMENT	dtx = fix(dt(1))+1:fix(dt(end));	if length(dtx)>0,		latx = interp1(dt,lat,dtx);		lonx = interp1(dt,lon,dtx);		for id = 1:length(dtx),			txt = m_text(lonx(id),latx(id),'o','fontweight','bold','fontsize',12);			set(txt,'verticalalignment','middle','horizontalalignment','center','Color','k');			fprintf('day=%.2f, flag=%.2f\n',dtx(id)-dtstart, rem( floor(dtx(id)-dtstart), nskip));			if rem( floor(dtx(id)-dtstart), nskip) == 0,				[y,jds] = dt2jdf(dtx(id));				jds = fix(jds);				tx = m_text(lonx(id)+delx, latx(id)+delx, sprintf('%d',jds), 'fontweight','normal','fontsize',14);				set(tx,'verticalalignment','bottom','horizontalalignment','left');			end		end	end	hold on;	% END POINT	tx = m_text(lon(end),lat(end),'o','fontweight','bold','fontsize',14);	set(tx,'verticalalignment','middle','horizontalalignment','center','Color','r');	tx = m_text(lon(end)+delx, lat(end)+delx, 'END', 'fontweight','normal','fontsize',14);	set(tx,'verticalalignment','bottom','horizontalalignment','left');    %% BROKEN CRUISE TRACK -- PLOT EACH SEGMENT	else	fprintf('broken into %d segments\n',length(inan));	% THE FIRST SEGMENT	dtseg = dtf(1:inan(1)-1);	latseg = latf(1:inan(1)-1);	lonseg = lonf(1:inan(1)-1);	m_track(lonseg,latseg);	% START POINT	tx = m_text(lonseg(1),latseg(1),'o','fontweight','bold','fontsize',14);	set(tx,'verticalalignment','middle','horizontalalignment','center','Color','r');	tx = m_text(lonseg(1)-delx, latseg(1)-delx, 'START', 'fontweight','bold','fontsize',14,'color','red');	set(tx,'verticalalignment','top','horizontalalignment','right');	% ALL JDAYS IN THIS SEGMENT	dtx = fix(dtseg(1))+1:fix(dtseg(end));	if length(dtx)>0,		latx = interp1(dtseg,latseg,dtx);		lonx = interp1(dtseg,lonseg,dtx);		for id = 1:length(dtx),			txt = m_text(lonx(id),latx(id),'o','fontweight','bold','fontsize',12);			set(txt,'verticalalignment','middle','horizontalalignment','center','Color','k');			if rem( floor(dtx(id)- fix(dtstart)), nskip) == 0,				[y,jds] = dt2jdf(dtx(id));				jds = fix(jds);				tx = m_text(lonx(id)+delx, latx(id)+delx, sprintf('%d',jds), 'fontweight','normal','fontsize',14);				set(tx,'verticalalignment','bottom','horizontalalignment','left');			end		end	end	hold on;    inan1 = find(diff(inan)>1);	Nsegs = length(inan1+1);			%% INTERMEDIATE SEGMENTS	for iseg = 1:length(inan1),		dtseg = dtf(   inan(inan1(iseg))+1:inan(inan1(iseg)+1)-1 );		latseg = latf( inan(inan1(iseg))+1:inan(inan1(iseg)+1)-1 );		lonseg = lonf( inan(inan1(iseg))+1:inan(inan1(iseg)+1)-1 );		m_track(lonseg,latseg);		% ALL JDAYS IN THIS SEGMENT		dtx = fix(dtseg(1))+1:fix(dtseg(end));		if length(dtx)>0,			latx = interp1(dtseg,latseg,dtx);			lonx = interp1(dtseg,lonseg,dtx);			for id = 1:length(dtx),				tx = m_text(lonx(id),latx(id),'o','fontweight','bold','fontsize',12);				set(tx,'verticalalignment','middle','horizontalalignment','center','Color','k');				if fix(rem( floor(dtx(id)-dtstart), nskip)) == 0,					[y,jds] = dt2jdf(dtx(id));					jds = fix(jds);					tx = m_text(lonx(id)+delx, latx(id)+delx, sprintf('%d',jds), 'fontweight','normal','fontsize',14);					set(tx,'verticalalignment','bottom','horizontalalignment','left');				end			end		end	end		% FINAL SEGMENT	dtseg = dtf(   inan(end)+1:end );	latseg = latf( inan(end)+1:end );	lonseg = lonf( inan(end)+1:end );	m_track(lonseg,latseg);	% ALL JDAYS IN THIS SEGMENT	dtx = fix(dtseg(1))+1:fix(dtseg(end));	if length(dtx)>0,		latx = interp1(dtseg,latseg,dtx);		lonx = interp1(dtseg,lonseg,dtx);		for id = 1:length(dtx),			tx = m_text(lonx(id),latx(id),'o','fontweight','bold','fontsize',12);			set(tx,'verticalalignment','middle','horizontalalignment','center','Color','k');			if fix(rem( floor(dtx(id)-dtstart), nskip)) == 0,				[y,jds] = dt2jdf(dtx(id));				jds = fix(jds);				tx = m_text(lonx(id)+delx, latx(id)+delx, sprintf('%d',jds), 'fontweight','normal','fontsize',14);				set(tx,'verticalalignment','bottom','horizontalalignment','left');			end		end	end	% PLOT THE FINAL POINT	% START POINT	tx = m_text(lonseg(end),latf(end),'o','fontweight','bold','fontsize',14);	set(tx,'verticalalignment','middle','horizontalalignment','center','Color','r');	tx = m_text(lonseg(end)+delx, latseg(end)+delx, 'END', 'fontweight','bold','fontsize',14,'color','red');	set(tx,'verticalalignment','bottom','horizontalalignment','left');	hold off;	endm_proj('get')set(gca,'fontname','helvetica','fontsize',14,'fontweight','bold');return